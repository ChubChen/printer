/**
 * Created by w44 on 15-3-16.
 */


var CronJob = require("cron").CronJob;
var moment = require('moment');

var cons = require('print_constants');
var nodePlatCons = cons.nodePlatCons;

var util = require('print_util');
var mongoDBUtil = util.mongoDBUtil;
var log = util.log;

var async = require('async');

var memory = require('print_memory');
var terminalArray = memory.terminalArray;
var webIo = memory.webIo;

var nodePlatAssist = require('print_assist').nodePlatAssist;

var TermCodeControl = function () {
};
//注意,程序刚启动时需要初始化term对象
TermCodeControl.prototype.T05Term = '';
TermCodeControl.prototype.T01Term = '';
TermCodeControl.prototype.T02Term = '';
TermCodeControl.prototype.T03Term = '';
TermCodeControl.prototype.T04Term = '';
TermCodeControl.prototype.T06Term = '';
TermCodeControl.prototype.T53Term = '';
TermCodeControl.prototype.T54Term = '';
TermCodeControl.prototype.T55Term = '';


//兑奖用期次
TermCodeControl.prototype.T05BonusTerm = '';
TermCodeControl.prototype.T01BonusTerm = '';
TermCodeControl.prototype.T02BonusTerm = '';
TermCodeControl.prototype.T03BonusTerm = '';
TermCodeControl.prototype.T04BonusTerm = '';
TermCodeControl.prototype.T06BonusTerm = '';
TermCodeControl.prototype.T53BonusTerm = '';
TermCodeControl.prototype.T54BonusTerm = '';
TermCodeControl.prototype.T55BonusTerm = '';

//足彩在售期次
TermCodeControl.prototype.T53SellTerm = {};
TermCodeControl.prototype.T54SellTerm = {};
TermCodeControl.prototype.T55SellTerm = {};


TermCodeControl.prototype.T01TermEndTime = '';
TermCodeControl.prototype.T02TermEndTime = '';
TermCodeControl.prototype.T03TermEndTime = '';
TermCodeControl.prototype.T04TermEndTime = '';
TermCodeControl.prototype.T05TermEndTime = '';
TermCodeControl.prototype.T06TermEndTime = '';
TermCodeControl.prototype.T53TermEndTime = '';
TermCodeControl.prototype.T54TermEndTime = '';
TermCodeControl.prototype.T55TermEndTime = '';

//高频期次对象
TermCodeControl.prototype.Terms = {};


TermCodeControl.prototype.term = function () {
    return {
        T05: TermCodeControl.prototype.T05Term,
        T01: TermCodeControl.prototype.T01Term,
        T02: TermCodeControl.prototype.T02Term,
        T03: TermCodeControl.prototype.T03Term,
        T04: TermCodeControl.prototype.T04Term,
        T06: TermCodeControl.prototype.T06Term,
        T53: TermCodeControl.prototype.T53Term,
        T54: TermCodeControl.prototype.T54Term,
        T55: TermCodeControl.prototype.T55Term
    }
};

TermCodeControl.prototype.bonusTerm = function () {
    return {
        T05: TermCodeControl.prototype.T05BonusTerm,
        T01: TermCodeControl.prototype.T01BonusTerm,
        T02: TermCodeControl.prototype.T02BonusTerm,
        T03: TermCodeControl.prototype.T03BonusTerm,
        T04: TermCodeControl.prototype.T04BonusTerm,
        T06: TermCodeControl.prototype.T06BonusTerm,
        T53: TermCodeControl.prototype.T53BonusTerm,
        T54: TermCodeControl.prototype.T54BonusTerm,
        T55: TermCodeControl.prototype.T55BonusTerm
    }
};

TermCodeControl.prototype.zcSellTerm = function () {
    return {
        T53: TermCodeControl.prototype.T53SellTerm,
        T54: TermCodeControl.prototype.T54SellTerm,
        T55: TermCodeControl.prototype.T55SellTerm
    }
};


TermCodeControl.prototype.termEndTime = function () {
    return {
        T05: {
            termCode: TermCodeControl.prototype.T05Term,
            endTime: TermCodeControl.prototype.T05TermEndTime
        }, T01: {
            termCode: TermCodeControl.prototype.T01Term,
            endTime: TermCodeControl.prototype.T01TermEndTime
        }, T02: {
            termCode: TermCodeControl.prototype.T02Term,
            endTime: TermCodeControl.prototype.T02TermEndTime
        }, T03: {
            termCode: TermCodeControl.prototype.T03Term,
            endTime: TermCodeControl.prototype.T03TermEndTime
        }, T04: {
            termCode: TermCodeControl.prototype.T04Term,
            endTime: TermCodeControl.prototype.T04TermEndTime
        }, T06: {
            termCode: TermCodeControl.prototype.T06Term,
            endTime: TermCodeControl.prototype.T06TermEndTime
        }, T53: {
            termCode: TermCodeControl.prototype.T53Term,
            endTime: TermCodeControl.prototype.T53TermEndTime
        }, T54: {
            termCode: TermCodeControl.prototype.T54Term,
            endTime: TermCodeControl.prototype.T54TermEndTime
        }, T55: {
            termCode: TermCodeControl.prototype.T55Term,
            endTime: TermCodeControl.prototype.T55TermEndTime
        }
    }
};


TermCodeControl.prototype.run = function () {
    var self = this;
    //每隔5分钟从平台取一次期次数据
    self.termInfo.start();
    self.task.start();
   // self.gpTerm.start();
   // self.getTerm();
    //self.gpTermExc();
};


TermCodeControl.prototype.task = new CronJob('0 */5 8-21 * * *', function () {
    log.info('普通游戏期次');
    TermCodeControl.prototype.getTerm();
}, null, true, 'Asia/Chongqing');


TermCodeControl.prototype.getTerm = function () {
    var body = {
        cond: {gameCode: {$in: ['T01', 'T02', 'T03', 'T04']}, status: 1200}
    };
    nodePlatAssist.sentCQ01(body, function (err, backMsgNode) {
        if (err) {
            TermCodeControl.prototype.getTerm();
        } else {
            var T53 = 0;
            var T54 = 0;
            var T55 = 0;
            TermCodeControl.prototype.T53SellTerm = {};
            TermCodeControl.prototype.T54SellTerm = {};
            TermCodeControl.prototype.T55SellTerm = {};
            var _body = JSON.parse(backMsgNode.body);
            var termArr = _body.rst;
            async.each(termArr, function (item, callback) {
                if (item.gameCode == 'T01') {
                    TermCodeControl.prototype.T01Term = parseInt(item.code);
                    TermCodeControl.prototype.T01TermEndTime = moment(item.endTime).valueOf();
                } else if (item.gameCode == 'T02') {
                    TermCodeControl.prototype.T02Term = parseInt(item.code);
                    TermCodeControl.prototype.T02TermEndTime = moment(item.endTime).valueOf();
                } else if (item.gameCode == 'T03') {
                    TermCodeControl.prototype.T03Term = parseInt(item.code);
                    TermCodeControl.prototype.T03TermEndTime = moment(item.endTime).valueOf();
                } else if (item.gameCode == 'T04') {
                    TermCodeControl.prototype.T04Term = parseInt(item.code);
                    TermCodeControl.prototype.T04TermEndTime = moment(item.endTime).valueOf();
                }else if (item.gameCode == 'T05') {
                    TermCodeControl.prototype.T05Term = parseInt(item.code);
                    TermCodeControl.prototype.T05TermEndTime = moment(item.endTime).valueOf();
                }
                else if (item.gameCode == 'T53') {
                    TermCodeControl.prototype.T53Term = parseInt(item.code);
                    TermCodeControl.prototype.T53TermEndTime = moment(item.endTime).valueOf();
                    //往数组里push
                    T53++;
                    TermCodeControl.prototype.T53SellTerm[item.code] = {
                        termCode: item.code,
                        index: T53
                    };
                } else if (item.gameCode == 'T54') {
                    TermCodeControl.prototype.T54Term = parseInt(item.code);
                    TermCodeControl.prototype.T54TermEndTime = moment(item.endTime).valueOf();
                    T54++;
                    TermCodeControl.prototype.T54SellTerm[item.code] = {
                        termCode: item.code,
                        index: T54
                    };
                } else if (item.gameCode == 'T55') {
                    TermCodeControl.prototype.T55Term = parseInt(item.code);
                    TermCodeControl.prototype.T55TermEndTime = moment(item.endTime).valueOf();

                    T55++;
                    TermCodeControl.prototype.T55SellTerm[item.code] = {
                        termCode: item.code,
                        index: T55
                    };
                }
                //callback();
            }, function (err) {

            })
        }
    });

};

TermCodeControl.prototype.gpTerm = new CronJob('*/10 * * * * *', function () {
    log.info('高频游戏期次查询');
    TermCodeControl.prototype.gpTermExc();
}, function () {
}, false, 'Asia/Chongqing');

TermCodeControl.prototype.gpTermExc = function () {
    TermCodeControl.prototype.queryLocalTerm('T05', function (item) {
        TermCodeControl.prototype.T05Term = parseInt(item.code);
        TermCodeControl.prototype.T05TermEndTime = moment(item.endTime).valueOf();
        var term = {};
        term[item.code] = moment(item.endTime).format('YYMMDDHHmmss');
        TermCodeControl.prototype.Terms['T05'] = term;
    });
};

TermCodeControl.prototype.queryLocalTerm = function (gameCode, cb) {
    mongoDBUtil.db.collection('localTerm', {safe: true}, function (err, coll) {
        var nowTime = moment().valueOf();
        coll.findOne({gameCode: gameCode, openTime: {$lt: nowTime}, endTime: {$gt: nowTime}}, function (err, term) {
            if (!err) {
                cb(term);
            } else {
                console.log(err);
            }
        })
    })
};


//每隔1分钟向界面通知一次期次相关情况
TermCodeControl.prototype.termInfo = new CronJob('0 */1 * * * *', function () {
    //logger.info('--在售期次--');
    //logger.info(TermUtil.prototype.term());
    //logger.info('--兑奖期次');
    //logger.info(TermUtil.prototype.bonusTerm());
    //logger.info('--足彩在售期次--');
    //logger.info(TermUtil.prototype.zcSellTerm());
    log.info('----高频相关信息----');

    mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
        var gameCodeArr = prop.gamCodeArray;
        var termInfo = [];
        var termCode = TermCodeControl.prototype.bonusTerm();
        var tc = TermCodeControl.prototype.term();
        async.eachSeries(gameCodeArr, function (item, callback) {
            collection.aggregate({$match: {gameCode: item}}, {
                $group: {
                    _id: '$termCode',
                    totalMoney: {$sum: '$amount'},
                    count: {$sum: 1}
                }
            }, function (err, result) {

                for (var i = 0; i < result.length; i++) {
                    var obj = result[i];
                    obj.gameCode = item;
                    obj.termCode = obj['_id'];
                    var thisTermCode = parseInt(obj.termCode);

                    if (item != 'T53' && item && 'T54' && item != 'T55') {
                        if (thisTermCode < tc[item]) {
                            obj.status = '处理中';
                        } else {
                            //等于当前期次,属于正在销售的期次
                            obj.status = '销售中'
                        }
                        termInfo.push(obj);
                    } else {
                        if (thisTermCode <= termCode[item]) {
                            obj.status = '处理中';
                        } else {
                            //等于当前期次,属于正在销售的期次
                            obj.status = '销售中'
                        }
                        termInfo.push(obj);
                    }

                }
                callback(null);
            })

        }, function (err) {
            log.error(termInfo);
            webIo.io.emit('TerminalPrintSuccessTerm', termInfo);
        })
    })
}, null, true, 'Asia/Chongqing');

