/**
 * Created by w44 on 15-3-5.
 */

var CronJob = require("cron").CronJob;
var async = require('async');


var nodePlatAssist = require('print_assist').nodePlatAssist;
var uuid = require('node-uuid');

var cons = require('print_constants');
var terminalCons = cons.terminalCons;
var nodePlatCons = cons.nodePlatCons;

var util = require('print_util');
var mongoDBUtil = util.mongoDBUtil;
var log = util.log;
var checkNumberUtil = util.checkNumberUtil;

var memory = require('print_memory');
var terminalArray = memory.terminalArray;
var webIo = memory.webIo;

var fs = require('fs');
var moment = require('moment');

var assist = require('print_assist');
var terminalAssist = assist.terminalAssist;

var BonusControl = function () {
};


/**
 * 根据终端机id兑奖
 * @param terminalId
 * 1.从数组中获取终端机对象
 * 2.从数据库中获取所有票
 * 3.发送请求
 */

BonusControl.prototype.run = function () {

    var self = this;

    //开启查询平台期次是否开奖任务
    //self.dealWithBonus.start();
   //self.produceBonusFile.start();
   //self.produceBonusFile2JC.start();
    //开启兑奖任务
   self.bonusTickets.start();
    //查询中奖数据插入兑奖库
   //self.produceTickets2WaitBonus.start();
    //开启FTP文件获取任务
   self.getFTPBounsTickets.start();
    //开启FTP文件信息处理任务
   self.dealWithBonuTicket.start();
   self.sendBouns2NodePlat.start();
  //self.updateTicketsInfo.start();
    /**
     * 数字彩兑奖
     * */
  //self.produceTickets2WaitBonusForSZ.start();
  //self.printTickets.start();
  //self.checkTicketsMoney.start();
  
};

//读取兑奖文件定时任务
//*/300 * * * * *
BonusControl.prototype.getFTPBounsTickets = new CronJob('*/1 * * *', function () {
    log.error('*******兑奖****** ftp任务');
    var date = moment().format('YYYYMMDD');
    var gameCodeArr = nodePlatCons.gamCodeArray;
    for (var i = 0; i < gameCodeArr.length; i++) {
        var gameCode = gameCodeArr[i];
        log.error('/data/app/issue/' + gameCode + '/' + date);
       bonusControl.getBonusFile('/data/app/issue/' + gameCode + '/' + date);
    }
}, null, false, 'Asia/Chongqing');


//读取兑奖文件方法
BonusControl.prototype.getBonusFileNew = function (path) {
    var self = this;
    var fileName = moment().format("YYYY-MM-DD");
    fs.stat(path + '/' + fileName, function (err, stat) {
                if (err) {
                    log.error(err);
                    return;
                }else {
                    // 读出所有的文件
                    log.error(path + '/' + fileName);
                    fs.readFile(path + '/' + fileName, 'UTF-8', function (err, data) {
                        if (!err) {
                            var arr = data.split('\n');
                            async.eachSeries(arr, function (item, fileReadCall) {
                                if (item) {
                                    mongoDBUtil.db.collection('BonusInfo', {safe: true}, function (err, CTets) {
                                        CTets.findOne({info: item}, function (err, data) {
                                            if (!data) {
                                                CTets.insert({
                                                    info: item,
                                                    status: terminalCons.bonus.status.wait,
                                                    crateTime: new Date().getTime()
                                                }, function () {
                                                    log.info(item + '已放入兑奖信息库');
                                                    fileReadCall(null);
                                                });
                                            } else {
                                                fileReadCall(null);
                                            }
                                        });
                                    });
                                } else {
                                    fileReadCall(null);
                                }
                            }, function (err) {
                            });
                        }
                    });
                }
            });
};

//读取兑奖文件方法
BonusControl.prototype.getBonusFile = function (path) {
    var self = this;
    fs.readdir(path, function (err, files) {
        //err 为错误 , files 文件名列表包含文件夹与文件
        if (err) {
            console.error('error:\n' + err);
            return;
        }
        log.info("文件的数量=============" + files.length);
        files.forEach(function (file) {
            fs.stat(path + '/' + file, function (err, stat) {
                if (err) {
                    log.error(err);
                    return;
                }
                if (stat.isDirectory()) {
                    // 如果是文件夹遍历
                    self.getBonusFile(path + '/' + file);
                } else {
                    // 读出所有的文件
                    log.error(path + '/' + file);
                    fs.readFile(path + '/' + file, 'UTF-8', function (err, data) {
                        if (!err) {
                            var arr = data.split('\n');
                            async.eachSeries(arr, function (item, fileReadCall) {
                                if (item) {
                                    mongoDBUtil.db.collection('BonusInfo', {safe: true}, function (err, CTets) {
                                        CTets.findOne({info: item}, function (err, data) {
                                            if (!data) {
                                                CTets.insert({
                                                    info: item,
                                                    status: terminalCons.bonus.status.wait,
                                                    crateTime: new Date().getTime()
                                                }, function () {
                                                    log.info(item + '已放入兑奖信息库');
                                                    fileReadCall(null);
                                                });
                                            } else {
                                                fileReadCall(null);
                                            }
                                        });
                                    });
                                } else {
                                    fileReadCall(null);
                                }
                            }, function (err) {
                            });
                        }
                    });
                }
            });

        });
    });
};


BonusControl.prototype.bonusTickets = new CronJob('*/10 * * * * *', function () {
    log.error('*******兑奖****** 兑奖任务');
    async.waterfall([function (cb) {
        //查找用于兑奖的终端机
        for (var i = 0; i < terminalArray.length; i++) {
            if (terminalArray[i].status == terminalCons.terminal.status.bonus) {
                cb(null, terminalArray[i]);
            }
        }
        ;
    }, function (terminal, cb) {
        log.error(terminal.terminalId + '：开始扫描兑奖');
        //log.info("终端机信息"+ terminal);
        //log.info('彩机兑奖区域' + terminal.area);
        mongoDBUtil.db.collection('TicketsWaitBonus', {safe: true}, function (err, collection) {
            var gameCodeArr = nodePlatCons.gamCodeArray;
            for (var i = 0; i < gameCodeArr.length; i++) {
                var gc = gameCodeArr[i];
                //todo 测试写死兑奖期次
                if (terminal.gameCode[gc]) {
                    collection.find({
                        status: terminalCons.ticket.status.in,
                        gameCode: gc,
                        area:terminal.area
                    }, {limit: 20}).toArray(function (err, tickets) {
                        if (tickets.length > 0 && terminal.status != terminalCons.terminal.status.inBonus) {
                            terminal.status = terminalCons.terminal.status.inBonus;
                            terminal.terminal.status = terminalCons.terminal.status.inBonus;
                            var msg = JSON.stringify(terminal.terminal);
                            log.error('有待兑奖票，已指定终端机' + terminal.terminalId + ' 兑奖中……');
                            webIo.io.emit('statusChange', msg);
                            var arr = new Array;
                            async.each(tickets, function (item, callback) {
                                if (terminal.gameCode[item.gameCode]) {
                                    var obj = item;
                                    if (item.gameCode == 'T53' || item.gameCode == 'T54' || item.gameCode == 'T55') {
                                        arr.push(obj);
                                        collection.findAndModify({'id': item.id}, {'id': -1}, {
                                            $set: {
                                                status: terminalCons.ticket.status.wait,
                                                bonusTerminal: terminal.terminalId
                                            }
                                        }, {new: true}, function (err, ticket) {
                                        })
                                    } else {
                                        arr.push(obj);
                                        collection.findAndModify({'id': item.id}, {'id': -1}, {
                                            $set: {
                                                status: terminalCons.ticket.status.wait,
                                                bonusTerminal: terminal.terminalId
                                            }
                                        }, {new: true}, function (err, ticket) {
                                        })
                                    }
                                }
                                callback(null);
                            }, function (err) {
                                cb(null, arr, terminal);
                            })
                        }
                    })
                }
            }
        });
    }, function (tickets, terminal, cb) {
        var _tickets = [];
        if (tickets.length == 0) {
            return;
        }
        for (var i = 0; i < tickets.length; i++) {
            var metaData = {};
            metaData.metaTicket = tickets[i].ticketSeq + '#' + tickets[i].ticketPwd + '\n';
            _tickets.push(metaData);
        }
        var headNode = {cmd: '0007', sequenceId: uuid.v4().replace(/\-/g, ''), terminalId: terminal.terminalId};
        var bodyNode = {tickets: _tickets, metaTicketName: tickets[0].metaTicketName};
        terminal.terminalControl.send0007(headNode, bodyNode);
        cb(null);
    }], function (err, result) {
        if (err) {
            log.info('err: ', err); // -> null
            log.info('result: ', result); // -> 16
        }
    })
}, null, false, 'Asia/Chongqing');


BonusControl.prototype.dealWithBonuTicket = new CronJob(' */30 * * * *', function () {
    log.error("*******兑奖****** 处理中奖文件到待兑奖库");
    var now = new Date().getTime();
    mongoDBUtil.db.collection('BonusInfo', {safe: true}, function (err, bonusInfo) {
        bonusInfo.find({status: terminalCons.bonus.status.wait}).toArray(function (err, infos) {
            async.eachSeries(infos, function (infoLine, termCallBack) {
                infoLine = infoLine.info;
                try {
                    if (infoLine.trim() != '') {
                        //todo 此处应判断当前库中是否有这张票,然后再做进一步操作
                        //5@2ad27e577d504423bb9c258abeaa1291@600@[{"bonus":600,"bonusBeforeTax":600,"level":2,"count":1}]@600@15007@01,02,03,04,05@1200
                        var strArr = infoLine.split('@');
                        var id = strArr[0];
                        var length = 32 - (id + '').length;
                        for (var i = 0; i < length; i++) {
                            id = '0' + id;
                        }
                        var bonus = strArr[2];
                        mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, terminalPrintSuccess) {
                            terminalPrintSuccess.findOne({id: id}, function (err, ticket) {
                                if (ticket) {
                                    delete ticket['_id'];
                                    var _ticket = {};
                                    _ticket.ticketSeq = ticket.ticketSeq;
                                    _ticket.ticketPwd = ticket.ticketPwd;
                                    _ticket.gameCode = ticket.gameCode;
                                    _ticket.metaTicketName = ticket.metaTicketName;
                                    _ticket.termCode = ticket.termCode; //期次
                                    _ticket.bonusTime = new Date().getTime();
                                    _ticket.ticketId = ticket.id;
                                    _ticket.outerId = ticket.outerId;
                                    _ticket.multiple = ticket.multiple;
                                    _ticket.amount = ticket.amount;
                                    _ticket.numbers = ticket.numbers;
                                    _ticket.bonus = bonus;
                                    _ticket.bonusTime = now;
                                    _ticket.status = terminalCons.ticket.status.in;
                                    mongoDBUtil.db.collection('TicketsWaitBonus', {safe: true}, function (err, ticketsWaitBonus) {
                                        if(!err){
                                            //正确则放入待兑奖库中
                                            ticketsWaitBonus.insert(ticket, function () {
                                                log.info(ticket.id + '已进入待兑奖库');
                                                //将兑奖信息状态改为已经处理
                                                bonusInfo.findAndModify({info: infoLine}, {'id': -1}, {$set: {status: terminalCons.bonus.status.had}}, {new: true}, function (err, result) {
                                                    if(!err){
                                                        log.info(infoLine + '： 已经处理');
                                                        termCallBack(null);
                                                    }
                                                });
                                            });
                                        }
                                    })
                                } else {
                                    //找不到票
                                    log.error(id + '找不到票');
                                    termCallBack(null);
                                }
                            })
                        });
                    } else {
                        termCallBack(null);
                    }
                    ;
                } catch (err) {
                    log.info('已出错');
                    log.info(infoLine);
                    termCallBack(null);
                }
            }, function (err) {
                log.error('兑奖期次及票据处理已经全部完成');
            });
        })
    });


}, null, false, 'Asia/Chongqing');

//获取中奖票，生成中奖文件 -- xiongpanming add
BonusControl.prototype.produceBonusFile = new CronJob('0 34 17 * * *', function () {
	
	log.error("*******查询中奖票****** 处理中奖票生成中奖文件到FTP文件");
	/*nodePlatAssist.queryBounsTickets(function(err,backMsgNode){
	   if(err){
	      log.info("********中奖票查询异常*********");
	   }else{
	      var outIds = backMsgNode.outIds;
	      if (outIds.length == 0) {
            log.info("no bouns ticket............");
            return;
          } */
        //查询出票成功的生成中奖文件
        //
        //status:terminalCons.ticket.status.in,outerId:'4110996'
        mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
		       collection.find({status:terminalCons.ticket.status.in}).toArray(function(err,docs){
                    if(docs.length >=1){
                      async.each(docs, function(item){
                        log.info("中奖文件的生成===" + item);
                          var ticketSeq = item.ticketSeq;
                          var ticketPwd = item.ticketPwd;
                          var fileName = moment().format('YYYY-MM-DD');
                          var ticketFile = '/data/app/issue/' + fileName;
                          var bodyNode = ticketSeq + " " + ticketPwd + " " + item.gameCode + " " + item.termCode + " " 
                                    +item.metaTicketName + " " +item.id + " " + item.outerId + " " + item.multiple + " " 
                                    + item.amount + " " + item.numbers;
                          fs.appendFile(ticketFile, bodyNode + '\n', 'utf-8', function (err) {
                            if (err) {
                                log.info(err);
                            } else {
                                log.info(bodyNode + '已写入' + ticketFile);
                                collection.update({id: item.id}, {$set: {status: terminalCons.ticket.status.over}}, {new: true}, function (err, result) {
                                    if(!err){
                                        log.info(item + ":已经处理");
                                    }
                                });
                            }
                        });
                      });
                    }
               });

               /*async.each(outIds, function (item) {
		       	  
		       	  var outId = item.outId;
		       	  collection.findOne({outId:outId},function(err,data){
		       	     
		       	     if(!data){
		       	        var ticketSeq = data.ticketSeq;  //出票系列号
		       	        var ticketPwd = data.ticketPwd; //票密码
		       	        var gameCode = data.gameCode; //彩种id
		       	        var data = moment().format('YYYY-MM-DD');
		       	        var fileName = data;
						        var ticketFile = '/data/app/issue/' + fileName;
						        var bodyNode = ticketSeq + " " + ticketPwd;
						        fs.appendFile(ticketFile, bodyNode + '\n', 'utf-8', function (err) {
						            if (err) {
						                log.info(err);
						            } else {
						                log.info(bodyNode + '已写入' + ticketFile);
						            }
						        });
						        
		       	     }else{
		       	        log.error("中奖票不存在或者未出票成功outId==" + outId);
		       	     }
		       	  });
		       });*/
	      });
}, null, false, 'Asia/Chongqing');

//现在用于竞彩足球的生成中奖文件
BonusControl.prototype.produceBonusFile2JC = new CronJob('30 43 16 * * *', function () {
    
    log.error("*******查询中奖票****** 处理中奖票生成中奖文件到FTP文件");
    nodePlatAssist.queryBounsTickets(function(err,backMsgNode){
       if(err){
          log.info("********中奖票查询异常*********");
       }else{
          if(backMsgNode.code == '1111'){
            log.info("no bouns ticket............");
            return;
          }
          var outIds = backMsgNode.outIds.tickets;
          log.info("bonus ticket length is " + outIds.length);
        /*mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
               collection.find({status:terminalCons.ticket.status.in}).toArray(function(err,docs){
                    if(docs.length >=1){
                      async.each(docs, function(item){
                        log.info("中奖文件的生成===" + item);
                          var ticketSeq = item.ticketSeq;
                          var ticketPwd = item.ticketPwd;
                          var fileName = moment().format('YYYY-MM-DD');
                          var ticketFile = '/data/app/issue/' + fileName;
                          var bodyNode = ticketSeq + " " + ticketPwd + " " + item.gameCode + " " + item.termCode + " " 
                                    +item.metaTicketName + " " +item.id + " " + item.outerId + " " + item.multiple + " " 
                                    + item.amount + " " + item.numbers;
                          fs.appendFile(ticketFile, bodyNode + '\n', 'utf-8', function (err) {
                            if (err) {
                                log.info(err);
                            } else {
                                log.info(bodyNode + '已写入' + ticketFile);
                                collection.update({id: item.id}, {$set: {status: terminalCons.ticket.status.over}}, {new: true}, function (err, result) {
                                    if(!err){
                                        log.info(item + ":已经处理");
                                    }
                                });
                            }
                        });
                      });
                    }
               });*/
            mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
               async.each(outIds, function (item) {
                  
                  var outerId = item.outerId;
                  collection.findOne({outerId:outerId},function(err,data){
                     
                     if(data){
                        var ticketSeq = data.ticketSeq;
                          var ticketPwd = data.ticketPwd;
                          var fileName = moment().format('YYYY-MM-DD');
                          var ticketFile = '/data/app/issue/' + fileName;
                          var bodyNode = ticketSeq + " " + ticketPwd + " " + data.gameCode + " " + data.termCode + " " 
                                    +data.metaTicketName + " " +data.id + " " + data.outerId + " " + data.multiple + " " 
                                    + data.amount + " " + data.numbers;
                          fs.appendFile(ticketFile, bodyNode + '\n', 'utf-8', function (err) {
                            if (err) {
                                log.info(err);
                            } else {
                                log.info(bodyNode + '已写入' + ticketFile);
                                collection.update({id: data.id}, {$set: {status: terminalCons.ticket.status.over}}, {new: true}, function (err, result) {
                                    if(!err){
                                        log.info(item + ":已经处理");
                                    }
                                });
                            }
                        });
                     }else{
                        log.error("中奖票不存在或者未出票成功outerId==" + outerId);
                     }
                  });
               });
              });
             }
          });
}, null, false, 'Asia/Chongqing');


//回传票奖金到出票平台
BonusControl.prototype.sendBouns2NodePlat = new CronJob('*/10 * * * * *', function () {
    
    log.error("*******回推中奖金额******");
        //1100:未回推
        //2100:已回推
        mongoDBUtil.db.collection('HadBonusTickets', {safe: true}, function (err, collection) {
               collection.find({platBounsStatus:{$in:['0000',null]}}).toArray(function(err,docs){
                    if(docs.length >=1){
                        async.each(docs, function(item) {
                            log.info(item);
                            log.info(item.id );
                            log.info( item.aftBouns);
                            if (item.id != null && item.aftBouns != null) {
                                var tempItem = {};
                                tempItem.cashTerminal = item.cashTerminal;
                                tempItem.cashAmount = 123;
                                tempItem.cashTime = item.bonusTime;
                                tempItem.id = item.id;
                                nodePlatAssist.sendBounsTickets(item, function (err, backMsgNode) {
                                    if (err) {
                                        log.info(err);
                                    } else {
                                        if (backMsgNode.code == '0000') {
                                            collection.update({outerId: item.outerId}, {$set: {platBounsStatus: '1111'}}, {new: true}, function (err, result) {
                                                if (!err) {
                                                    log.info(item + ":中奖金额回推已经处理");
                                                }
                                            });
                                        } else {
                                            log.info("出票平台未知异常");
                                        }
                                    }
                                });
                            }
                        });
                    }else{
                        log.info("没有需要回推奖金的票");
                    }
               });

          });
}, null, false, 'Asia/Chongqing');


//竞彩兑奖优化 2015-10-06（xiongpanming）
BonusControl.prototype.produceTickets2WaitBonus = new CronJob('30 44 11 * * *', function () {
    
    log.error("*******查询中奖票****** 处理中奖票到TicketsWaitBonus表中");
    
    nodePlatAssist.queryBounsTickets(function(err,backMsgNode){
       if(err){
          log.info("********中奖票查询异常*********");
       }else{
          if(backMsgNode.code == '1111'){
            log.info("no bouns ticket............");
            return;
          }
          var outIds = backMsgNode.outIds.tickets;
          log.info("bonus ticket length is " + outIds.length);
       
            mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
               async.each(outIds, function (item) {
                  
                  var outerId = item.outerId;
                  collection.findOne({outerId:outerId},function(err,data){
                     if(data){
                        var ticket = {};
                        ticket.ticketSeq = data.ticketSeq;
                        ticket.ticketPwd = data.ticketPwd;
                        ticket.gameCode = data.gameCode;
                        ticket.metaTicketName = data.metaTicketName;
                        ticket.termCode = data.termCode; //期次
                        ticket.bonusTime = new Date().getTime();
                        ticket.ticketId = data.id;
                        ticket.outerId = data.outerId;
                        ticket.multiple = data.multiple;
                        ticket.amount = data.amount;
                        ticket.numbers = data.numbers;
                       // ticket.terminalId = data.terminalId;//出票终端
                        var terminalId = data.terminalId;
                        if(terminalId.indexOf('00037190')){
                            ticket.area = 'lw';
                        }else if(terminalId.indexOf('00037030')){
                            ticket.area = 'qd';
                        }else if(terminalId.indexOf('00061010')){
                            ticket.area = 'xa';
                        }else if(terminalId.indexOf('00061270')){
                            ticket.area = 'yl';
                        }
                        ticket.status = terminalCons.ticket.status.in;
                        mongoDBUtil.db.collection('TicketsWaitBonus', {safe: true}, function (err, ticketsWaitBonus) {
                            if (!err) {
                                //正确则放入待兑奖库中
                                ticketsWaitBonus.insert(ticket, function () {
                                    log.info(ticket.ticketSeq + '已进入待兑奖库');
                                });
                            } 
                        });
                     }else{
                        log.error("中奖票不存在或者未出票成功outerId==" + outerId);
                     }
                  });
               });
              });
             }
          });
}, null, false, 'Asia/Chongqing');

//数字彩兑奖优化
BonusControl.prototype.produceTickets2WaitBonusForSZ = new CronJob('30 45 11 * * *', function () {

    mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
        collection.find({gameCode:{$ne:'T51'},status:{$ne:'1200'}}).toArray(function(err,docs){
            if(docs.length >=1){
                async.each(docs, function(data){
                    var ticket = {};
                    ticket.ticketSeq = data.ticketSeq;
                    ticket.ticketPwd = data.ticketPwd;
                    ticket.gameCode = data.gameCode;
                    ticket.metaTicketName = data.metaTicketName;
                    ticket.termCode = data.termCode; //期次
                    ticket.bonusTime = new Date().getTime();
                    ticket.ticketId = data.id;
                    ticket.outerId = data.outerId;
                    ticket.multiple = data.multiple;
                    ticket.amount = data.amount;
                    ticket.numbers = data.numbers;
                    //ticket.terminalId = data.terminalId;//出票终端
                    var terminalId = data.terminalId;
                        if(terminalId.indexOf('00037190')){
                            ticket.area = 'lw';
                        }else if(terminalId.indexOf('00037030')){
                            ticket.area = 'qd';
                        }else if(terminalId.indexOf('00061010')){
                            ticket.area = 'xa';
                        }else if(terminalId.indexOf('00061270')){
                            ticket.area = 'yl';
                        }
                    ticket.status = terminalCons.ticket.status.in;
                    mongoDBUtil.db.collection('TicketsWaitBonus', {safe: true}, function (err, ticketsWaitBonus) {
                        if (!err) {
                            //正确则放入待兑奖库中
                            ticketsWaitBonus.insert(ticket, function () {
                                log.info(ticket.ticketSeq + '已进入待兑奖库');
                                collection.update({id: data.id}, {$set: {status: terminalCons.ticket.status.over}}, {new: true}, function (err, result) {
                                    if(!err){
                                        log.info(data.id + ":状态已修改");
                                    }
                                });
                            });
                        } 
                    });
                });
            }else{
                log.info("没有需要兑奖的数字彩票");
            }
        });
    });
}, null, false, 'Asia/Chongqing');

//票面信息修复
BonusControl.prototype.updateTicketsInfo = new CronJob('0 11 13 * * *', function () {
    
        mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
               collection.find({gameCode:'T51',ticketSeq:''}).toArray(function(err,docs){
                    if(docs.length >=1){
                      async.each(docs, function(item){
                           var arr = item.metaTicket.split(/\n/);
                           var chuan = arr[4].replace(/\D/g, '');

                            var tar = arr[6].replace(/\s+/g, "|");
                            arr = tar.split('|');
                            var ticketSeq = arr[0].replace(/-/g, "");
                            var ticketPwd2 = arr[1];
                            var ticketPwd = arr[2];
                           collection.update({outerId: item.outerId}, {$set: {chuan:chuan,ticketSeq:ticketSeq,ticketPwd2:ticketPwd2,ticketPwd:ticketPwd}}, {new: true}, function (err, result) {
                               log.info("票面信息修复成功");
                           });
                         
                      });
                    }
               });

          });
}, null, false, 'Asia/Chongqing');


//票据批量打印
BonusControl.prototype.printTickets = new CronJob('0 45 16 * * *', function () {

    var terminal;

    for (var j = 0; j < terminalArray.length; j++) {
        if (terminalArray[j].status == terminalCons.terminal.status.print) {
            terminal = terminalArray[j];
            break;
        }
    }
    mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
        collection.find({takeTime:{$gt:1444406400000},terminalId:'0003703004417101',status:{$ne:'1000'}}).toArray(function(err,docs){
            if(docs.length >=1){
                 async.each(docs, function(item){
                     if (terminal) {
                        terminalAssist.printTicket(terminal.terminalId, item.id, function (err) {
                            if(err){
                                log.info(item.id+"打印失败");
                            }else{
                                log.info(item.id+"打印成功");
                                /*collection.update({id: item.id}, {$set: {status: '1000'}}, {new: true}, function (err, result) {
                                    log.info(item.id+"打印状态已修改");
                                });*/
                            }
                        });
                     }
                 });
            }
        });
    });
}, null, false, 'Asia/Chongqing');

//平台金额和票面金额对比
BonusControl.prototype.checkTicketsMoney = new CronJob('*/2 * * * * *', function () {
    log.info("脚本命令执行成功");
    /*var platMoney = 0; //平台金额
    var ticketMoney = 0; //票面金额
    var different = 0;
    var test = {};
    test.value = null;
    mongoDBUtil.db.collection('TerminalPrintSuccess', {safe: true}, function (err, collection) {
        collection.find({takeTime:{$gt:1444406400000}}).toArray(function(err,docs){
            if(docs.length >=1){
                 async.each(docs, function(item){
                     var flag = checkNumberUtil.checkMut(item,item.metaTicket);
                     if(!flag){
                        different++;
                        log.info("平台金额和票面金额不一致："+item.id);
                     }
                 });
                 log.info("平台金额和票面金额不一致的数量："+different);
            }
        });
    });*/
}, null, false, 'Asia/Chongqing');

var bonusControl = new BonusControl();
module.exports = bonusControl;
/*
mongoDBUtil.init(function(){
    bonusControl.dealWithBonuTicket.start();
})*/

